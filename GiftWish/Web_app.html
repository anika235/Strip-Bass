<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GiftWish - Social Wishlists</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&family=Quicksand:wght@300..700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />

    <script
      src="https://cdn.plot.ly/plotly-2.24.1.min.js"
      charset="utf-8"
    ></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/toastify-js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "var(--primary-color)",
              secondary: "var(--secondary-color)",
              accent: "var(--accent-color)",
              dark: "var(--dark-color)",
              light: "var(--light-color)",
              background: "var(--background-color)",
              card: "var(--card-color)",
            },
            boxShadow: {
              default: "var(--shadow)",
            },
            borderRadius: {
              default: "var(--border-radius)",
            },
          },
        },
      };
    </script>
    <style>
      :root {
        --primary-color: #ff6b6b;
        --secondary-color: #4ecdc4;
        --accent-color: #ffe66d;
        --dark-color: #292f36;
        --light-color: #f7fff7;
        --background-color: #f5f5f5;
        --card-color: #ffffff;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --border-radius: 12px;
        --text-color: #333333;
      }
      .dark {
        --primary-color: #ff8e8e;
        --secondary-color: #6ed7d0;
        --accent-color: #fff38d;
        --dark-color: #1a1f24;
        --light-color: #e5f0e5;
        --background-color: #121212;
        --card-color: #1e1e1e;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        --text-color: #e0e0e0;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      html {
        scroll-behavior: smooth;
      }
      body {
        color: var(--text-color);
        background-color: var(--background-color);
        overflow-x: hidden;
      }
      .fredoka {
        font-family: "Fredoka", sans-serif;
        font-optical-sizing: auto;
        font-style: normal;
        font-variation-settings: "wdth" 100;
      }
      .quicksand {
        font-family: "Quicksand", sans-serif;
        font-optical-sizing: auto;
        font-style: normal;
      }
      .search-container {
        margin-bottom: 20px;
      }
      .search-input {
        display: flex;
        margin-bottom: 15px;
      }
      .search-input input {
        flex-grow: 1;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: var(--border-radius) 0 0 var(--border-radius);
        font-size: 1rem;
        background-color: var(--card-color);
        color: var(--text-color);
      }
      .search-input input:focus {
        outline: none;
        border-color: var(--primary-color);
      }
      .btn-search {
        background-color: var(--primary-color);
        color: white;
        padding: 10px 15px;
        border-radius: 0 var(--border-radius) var(--border-radius) 0;
        cursor: pointer;
      }
      section {
        min-height: calc(100vh - 80px);
      }
      .feed-filters select {
        padding: 8px 15px;
        border-radius: 5px;
        border: 1px solid #ddd;
        margin-right: 10px;
        background-color: var(--card-color);
        color: var(--text-color);
      }
      .feed-wishlist-card {
        background-color: var(--card-color);
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow);
        transition: all 0.3s;
        cursor: pointer;
        min-width: 300px;
        max-width: 300px;
      }
      .feed-wishlist-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }
      .feed-card-header {
        padding: 15px;
        border-bottom: 1px solid #eee;
      }
      .feed-card-title {
        font-weight: 600;
        margin-bottom: 5px;
      }
      .feed-card-author {
        font-size: 0.9rem;
        color: #666;
      }
      .feed-card-body {
        padding: 15px;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }
      .feed-item {
        height: 100px;
        background-color: #f9f9f9;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
      }
      .feed-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .feed-item-claimed {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: rgba(76, 175, 80, 0.9);
        color: white;
        padding: 3px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
      }
      .feed-card-footer {
        padding: 15px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .feed-card-stats {
        display: flex;
        gap: 15px;
      }
      .feed-stat {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.8rem;
        color: #666;
      }
      .product-card {
        transition: all 0.3s;
        min-width: 180px;
        max-width: 180px;
        min-height: 280px;
        background-color: var(--card-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        position: relative;
      }
      .product-card:hover {
        cursor: grab;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      .wishlist-item-card {
        min-width: 150px;
        max-width: 150px;
        min-height: 220px;
        display: flex;
        flex-direction: column;
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
      }
      .opacity-50 {
        opacity: 0.5;
      }
      .cursor-not-allowed {
        cursor: not-allowed;
      }
      #trends-container {
        overflow: hidden;
        position: relative;
        min-height: 400px;
      }
      #trends-chart {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
      }
      #wishlist .sortable-ghost {
        opacity: 0.4;
        background: var(--secondary-color);
      }
      #wishlist .sortable-drag {
        opacity: 0.9 !important;
        transform: scale(1.05);
      }
      #savedWishlistsArea {
        overflow: hidden;
      }
      @media (max-width: 768px) {
        .container {
          padding: 1rem;
        }
        .feed-wishlist-card {
          min-width: calc(100% - 2rem);
          max-width: calc(100% - 2rem);
        }
        .product-card {
          min-width: 150px;
          max-width: 150px;
          min-height: 250px;
        }
        .wishlist-item-card {
          min-width: 120px;
          max-width: 120px;
          min-height: 180px;
        }
        .feed-card-body {
          grid-template-columns: repeat(2, minmax(100px, 1fr));
          gap: 8px;
          padding: 8px;
        }
        .search-input {
          flex-direction: column;
        }
        .search-input input {
          border-radius: var(--border-radius);
        }
        .btn-search {
          border-radius: var(--border-radius);
          margin-top: 0.5rem;
        }
        .feed-filters {
          flex-direction: column;
          gap: 0.5rem;
        }
        .feed-filters select {
          width: 100%;
          margin: 0.25rem 0;
        }
        .feed-card-title {
          font-size: 1rem;
        }
        .feed-card-author {
          font-size: 0.8rem;
        }
        .progress-bar {
          margin: 1rem 0;
        }
        .theme-toggle {
          width: 50px;
          height: 25px;
        }
        .toggle-ball {
          width: 20px;
          height: 20px;
        }
        #savedWishlistsArea {
          scroll-snap-type: x mandatory;
          scroll-padding: 0 1rem;
        }
        #sidePanel {
          will-change: transform;
        }
        .feed-wishlist-card {
          scroll-snap-align: start;
          flex-shrink: 0;
        }
        .dark .toggle-ball {
          transform: translateX(25px);
        }
      }
      @media (max-width: 640px) {
        #resetModal > div,
        #createWishlistModal > div,
        #viewWishlistModal > div {
          width: 95%;
          margin: 0.5rem;
        }
        .modal-content {
          padding: 1rem;
        }
        .product-card {
          min-width: calc(50% - 1rem);
          max-width: calc(50% - 1rem);
          min-height: 220px;
        }
      }
      @media (max-width: 480px) {
        header {
          padding: 0 1rem;
        }
        .feed-card-footer {
          flex-direction: column;
          gap: 0.5rem;
          align-items: flex-start;
        }
        .feed-card-stats {
          flex-wrap: wrap;
        }
        .feed-stat {
          font-size: 0.75rem;
        }
        .product-card {
          min-width: calc(50% - 1rem);
          max-width: calc(50% - 1rem);
          min-height: 200px;
        }
        .wishlist-item-card {
          min-width: calc(50% - 1rem);
          max-width: calc(50% - 1rem);
          min-height: 160px;
        }
      }
      #resetWishList:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background-color: var(--background-color) !important;
      }
      .progress-bar {
        height: 10px;
        background-color: #e0e0e0;
        border-radius: 5px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        background-color: var(--primary-color);
        transition: width 0.3s;
      }
      .confetti-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1000;
      }
      .theme-toggle {
        position: relative;
        width: 60px;
        height: 30px;
        border-radius: 15px;
        background-color: var(--card-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 5px;
        box-shadow: var(--shadow);
      }
      .theme-toggle i {
        font-size: 16px;
        color: var(--text-color);
      }
      .toggle-ball {
        position: absolute;
        width: 24px;
        height: 24px;
        background-color: var(--primary-color);
        border-radius: 50%;
        transition: transform 0.3s ease;
        left: 3px;
      }
      .dark .toggle-ball {
        transform: translateX(30px);
      }
      .bg-card {
        background-color: var(--card-color);
      }
      .bg-background {
        background-color: var(--background-color);
      }
      .text-primary {
        color: var(--primary-color);
      }
      .text-secondary {
        color: var(--secondary-color);
      }
      .text-accent {
        color: var(--accent-color);
      }
      .text-dark {
        color: var(--dark-color);
      }
      .text-light {
        color: var(--light-color);
      }
      #plotly-fulfillment-animation {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80vw;
        max-width: 600px;
        height: 400px;
        z-index: 1001;
        background-color: var(--card-color);
        border-radius: var(--border-radius);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        pointer-events: none;
      }
      .claimed-status-btn {
        background-color: #4caf50;
        color: white;
        border-radius: 9999px;
        padding: 2px 8px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .claimed-status-btn:hover {
        background-color: #45a049;
      }
      .claimed-status-btn i {
        margin-right: 4px;
      }
    </style>
  </head>
  <body
    class="flex flex-col items-center h-screen w-full relative overflow-auto"
  >
    <div
      class="container mx-auto h-screen relative z-0 overflow-auto w-full max-w-none overflow-x-hidden"
    >
      <header
        class="sticky top-0 z-30 w-full min-h-[80px] max-h-[80px] fredoka flex items-center justify-between gap-5 px-5 bg-background/80 backdrop-blur-sm"
      >
        <div class="flex items-center gap-2.5 text-primary">
          <i class="fas fa-gift text-2xl"></i>
          <h1 class="text-4xl font-semibold">GiftWish</h1>
        </div>

        <nav class="hidden md:flex items-center gap-8">
          <a
            href="#"
            onclick="showView('explore')"
            class="text-lg hover:text-primary transition-colors"
            >Explore</a
          >
          <a
            href="#"
            onclick="showView('community')"
            class="text-lg hover:text-primary transition-colors"
            >Community</a
          >
        </nav>

        <div class="flex items-center gap-4">
          <div class="theme-toggle" id="themeToggle">
            <i class="fas fa-moon"></i><i class="fas fa-sun"></i>
            <div class="toggle-ball"></div>
          </div>
          <button
            id="menu"
            class="md:hidden p-2 text-primary hover:text-secondary transition duration-300"
          >
            <i class="fa-solid fa-bars text-xl"></i>
          </button>
        </div>
      </header>

      <section
        id="explore"
        class="transition-opacity duration-300 ease-in-out view opacity-100 pointer-events-auto pt-[80px] quicksand flex flex-col gap-5 w-full p-5 mb-5"
      >
        <div
          id="wishlist-editor-section"
          class="min-h-[400px] flex flex-col w-full rounded-lg bg-card gap-2.5 p-5 shadow-default"
        >
          <div
            class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2"
          >
            <h2
              id="wishlist-editor-title"
              class="text-2xl text-gray-800 font-bold dark:text-gray-200 flex-shrink-0"
            >
              Create Your Wishlist
            </h2>
            <div class="flex items-center gap-2.5 flex-wrap">
              <button
                id="resetWishList"
                class="px-3 py-1.5 text-sm text-white bg-gray-400 rounded-lg hover:bg-gray-600 transition duration-300"
                disabled
                title="Wishlist is empty"
              >
                <i class="fa-solid fa-trash-arrow-up mr-1"></i> Reset
              </button>
              <button
                id="saveWishlistBtn"
                class="px-3 py-1.5 text-sm text-white bg-secondary rounded-lg hover:bg-primary transition duration-300"
              >
                <i class="fas fa-save mr-1"></i> Save List...
              </button>
              <button
                id="shareWishList"
                class="px-3 py-1.5 text-sm text-white bg-primary rounded-lg hover:bg-secondary transition duration-300"
              >
                <i class="fa-solid fa-share-nodes mr-1"></i> Share
              </button>
            </div>
          </div>
          <div class="flex items-center justify-between mb-2 mt-2">
            <span class="dark:text-gray-300"
              >Progress: <span id="progress-percent">0</span>%</span
            >
            <button
              id="fulfill-btn"
              class="px-3 py-1 text-sm bg-accent text-dark rounded-lg hover:bg-primary hover:text-light transition duration-300 hidden"
            >
              Mark as Fulfilled
            </button>
          </div>
          <div class="progress-bar w-full mb-4">
            <div
              id="progress-fill"
              class="progress-fill"
              style="width: 0%"
            ></div>
          </div>
          <div
            id="wishlist"
            class="flex-1 flex flex-row items-start flex-wrap gap-3 p-3 overflow-auto border-2 border-dashed border-secondary rounded-lg min-h-[200px] relative bg-gray-50/50 dark:bg-gray-800/50"
          >
            <div
              id="noListText"
              class="w-full h-full flex flex-col items-center justify-center absolute inset-0"
            >
              <i class="fas fa-gifts text-4xl text-secondary mb-3"></i>
              <h3 class="text-lg text-secondary font-semibold">
                Drag & Drop Zone
              </h3>
              <p class="text-gray-500 dark:text-gray-400">
                Add products from below or reorder items here
              </p>
            </div>
          </div>
        </div>

        <div
          class="min-h-fit flex flex-col w-full rounded-lg bg-card gap-2.5 p-5 shadow-default"
        >
          <div
            class="flex flex-col md:flex-row justify-between items-center gap-4"
          >
            <h2 class="text-2xl text-gray-800 font-bold dark:text-gray-200">
              Find Products
            </h2>
            <div class="search-container w-full md:w-1/2">
              <div class="search-input">
                <input
                  type="text"
                  placeholder="Search products..."
                  id="product-search"
                />
                <button class="btn btn-search" id="search-btn">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="flex overflow-x-auto py-2 gap-3 mb-2">
            <button
              class="category-btn px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition duration-300 whitespace-nowrap"
              data-category="all"
            >
              All
            </button>
            <button
              class="category-btn px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-white rounded-lg hover:bg-secondary hover:text-white transition duration-300 whitespace-nowrap"
              data-category="electronics"
            >
              Electronics
            </button>
            <button
              class="category-btn px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-white rounded-lg hover:bg-secondary hover:text-white transition duration-300 whitespace-nowrap"
              data-category="fashion"
            >
              Fashion
            </button>
            <button
              class="category-btn px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-white rounded-lg hover:bg-secondary hover:text-white transition duration-300 whitespace-nowrap"
              data-category="home"
            >
              Home
            </button>
            <button
              class="category-btn px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-white rounded-lg hover:bg-secondary hover:text-white transition duration-300 whitespace-nowrap"
              data-category="toys"
            >
              Toys
            </button>
            <button
              class="category-btn px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-white rounded-lg hover:bg-secondary hover:text-white transition duration-300 whitespace-nowrap"
              data-category="books"
            >
              Books
            </button>
            <button
              class="category-btn px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-white rounded-lg hover:bg-secondary hover:text-white transition duration-300 whitespace-nowrap"
              data-category="fitness"
            >
              Fitness
            </button>
          </div>
          <div
            id="products"
            class="flex-1 flex flex-row flex-wrap bg-gray-100 dark:bg-gray-800 rounded gap-3 p-3 overflow-auto min-h-[350px]"
          ></div>
        </div>

        <div class="flex flex-col lg:flex-row gap-5">
          <div
            class="flex-1 flex flex-col bg-card min-h-[400px] max-h-[500px] gap-5 p-5 rounded-lg shadow-default"
          >
            <h2 class="text-xl text-black font-bold dark:text-gray-200">
              Product Suggestion Trends
            </h2>
            <div class="flex-1 w-full" id="trends-container">
              <div id="trends-chart"></div>
            </div>
          </div>
          <div
            id="savedWishlistsArea"
            class="flex-1 flex flex-col bg-card min-h-[400px] max-h-[500px] gap-2.5 p-5 rounded-lg shadow-default"
          >
            <h2 class="text-xl text-gray-800 font-bold dark:text-gray-200 mb-2">
              Your Saved Wishlists
            </h2>
            <div
              id="savedWishlistsContainer"
              class="flex flex-row overflow-auto gap-4 p-2 snap-x snap-mandatory flex-grow"
            >
              <div
                id="noSavedWishlistText"
                class="w-full h-full flex flex-col items-center justify-center text-center"
              >
                <i class="fas fa-folder-open text-4xl text-gray-400 mb-3"></i>
                <h3 class="text-md text-secondary font-semibold">
                  No Saved Wishlists
                </h3>
                <p class="text-gray-500 dark:text-gray-400 text-sm">
                  Use the "Save List" button above to save your creation!
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section
        id="community"
        class="transition-opacity duration-300 ease-in-out view opacity-0 pointer-events-none translate-x-full fixed inset-0 pt-[80px] quicksand flex flex-col gap-5 w-full p-5 overflow-y-auto"
      >
        <div
          class="flex flex-col w-full rounded-lg bg-card gap-5 p-5 shadow-default"
        >
          <div class="flex flex-col md:flex-row md:items-center gap-5">
            <h2 class="text-2xl text-gray-800 font-bold dark:text-gray-200">
              Community Wishlists
            </h2>
            <div class="feed-filters flex-1 flex flex-wrap">
              <select id="category-filter">
                <option value="all">All Categories</option>
                <option value="electronics">Electronics</option>
                <option value="fashion">Fashion</option>
                <option value="home">Home & Garden</option>
                <option value="toys">Toys</option>
                <option value="books">Books</option>
              </select>
              <select id="sort-filter">
                <option value="popular">Most Popular</option>
                <option value="recent">Most Recent</option>
                <option value="fulfilled">Recently Fulfilled</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
            <div
              class="flex flex-col w-full min-h-[300px] bg-gray-50 dark:bg-gray-800 p-4 rounded-lg shadow-inner"
            >
              <h4 class="text-xl text-gray-800 dark:text-gray-200">
                Wishlist Stats (Placeholder)
              </h4>
              <div id="total-wishlists-chart" class="flex-1 flex w-full"></div>
            </div>
            <div
              class="flex flex-col w-full min-h-[300px] bg-gray-50 dark:bg-gray-800 p-4 rounded-lg shadow-inner"
            >
              <h4 class="text-xl text-gray-800 dark:text-gray-200">
                Popular Item Categories
              </h4>
              <div id="categories-chart" class="flex-1 flex w-full"></div>
            </div>
          </div>
          <div
            id="communityWishLists"
            class="flex flex-row flex-nowrap overflow-x-auto gap-5 p-2.5"
          >
            <div class="w-full flex items-center justify-center p-10">
              <p class="text-gray-500 dark:text-gray-400">
                Loading community wishlists...
              </p>
            </div>
          </div>
        </div>
      </section>
    </div>
    <div
      id="backDrop"
      class="fixed h-screen w-full left-0 top-0 hidden bg-black/50 z-40"
    ></div>
    <aside
      id="sidePanel"
      class="transform transition-all duration-300 ease-in-out fixed flex flex-col gap-5 top-0 left-0 h-screen overflow-auto min-w-[250px] max-w-full w-fit bg-card shadow-lg shadow-secondary -translate-x-full rounded-r p-5 z-50"
    >
      <div
        class="relative flex-1 flex flex-col items-center justify-center gap-2 text-primary"
      >
        <h2 class="text-2xl font-medium">Navigate</h2>
        <div class="w-full h-0.5 bg-primary rounded-t"></div>
        <div class="flex-1 flex flex-col p-2.5 gap-5">
          <button
            onclick="showView('explore'); closeSidePanel();"
            class="transition-all duration-300 ease-in-out w-full hover:text-secondary hover:border-b border-secondary text-left"
          >
            Explore & Create
          </button>
          <button
            onclick="showView('community'); closeSidePanel();"
            class="transition-all duration-300 ease-in-out w-full hover:text-secondary hover:border-b border-secondary text-left"
          >
            Community Feed
          </button>
        </div>
      </div>
    </aside>

    <canvas id="confetti-canvas" class="confetti-canvas"></canvas>

    <div
      id="resetModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div class="bg-card rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-semibold mb-4 dark:text-gray-200">
          Reset Wishlist Editor
        </h3>
        <p class="text-gray-600 dark:text-gray-300 mb-6">
          Are you sure you want to remove all items from the current wishlist
          editor?
        </p>
        <div class="flex justify-end gap-4">
          <button
            id="cancelReset"
            class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-300"
          >
            Cancel
          </button>
          <button
            id="confirmReset"
            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition duration-300"
          >
            Reset
          </button>
        </div>
      </div>
    </div>

    <div
      id="viewWishlistModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 overflow-y-auto p-4"
    >
      <div class="bg-card rounded-lg p-6 max-w-3xl w-full my-8">
        <div class="flex justify-between items-center mb-4">
          <h3
            id="viewWishlistTitle"
            class="text-xl font-semibold dark:text-gray-200"
          >
            Wishlist Details
          </h3>
          <button
            id="closeViewWishlist"
            class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="viewWishlistContent" class="mb-6">
          <p
            id="viewWishlistAuthor"
            class="text-gray-600 dark:text-gray-300 mb-4"
          ></p>
          <div
            id="viewWishlistItems"
            class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"
          ></div>
        </div>
        <div
          class="flex flex-col sm:flex-row justify-end items-center gap-4 mt-6 border-t pt-4"
        >
          <div id="collaborationStatus" class="flex-1 text-sm">
            <div id="notCollaborative" class="text-gray-500 dark:text-gray-400">
              <p>
                <i class="fas fa-user mr-2"></i>This wishlist is not set up for
                group contributions.
              </p>
            </div>
            <div id="collaborativeWishlist" class="hidden">
              <div class="mb-2">
                <p class="text-gray-700 dark:text-gray-300">
                  <i class="fas fa-users-gear mr-1 text-secondary"></i>
                  <span id="collabType">Open</span> collaboration mode enabled
                </p>
                <div id="contributorsArea" class="mt-1 flex flex-wrap gap-1">
                </div>
              </div>
            </div>
          </div>
          <div class="flex gap-2">
            <button
              id="contributeWishlist"
              class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-primary transition duration-300 w-full sm:w-auto"
            >
              <i class="fas fa-users mr-2"></i>Join Group Gift
            </button>
            <button
              id="shareCollabLink"
              class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition duration-300 w-full sm:w-auto hidden"
            >
              <i class="fas fa-share-nodes mr-2"></i>Share Link
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="createWishlistModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div class="bg-card rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold dark:text-gray-200">
            Save New Wishlist
          </h3>
          <button
            id="closeCreateWishlist"
            class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="createWishlistForm" class="mb-6">
          <div class="mb-4">
            <label
              class="block text-gray-700 dark:text-gray-300 mb-2"
              for="wishlistTitle"
              >Wishlist Title</label
            >
            <input
              type="text"
              id="wishlistTitle"
              class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white"
              placeholder="e.g., Birthday Bash, Dream Kitchen"
              required
            />
          </div>
          <div class="mb-4">
            <label
              class="block text-gray-700 dark:text-gray-300 mb-2"
              for="wishlistDescription"
              >Description (Optional)</label
            >
            <textarea
              id="wishlistDescription"
              class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white"
              placeholder="What's this wishlist for?"
              rows="3"
            ></textarea>
          </div>
          <div class="mb-4">
            <label class="flex items-center text-gray-700 dark:text-gray-300">
              <input
                type="checkbox"
                id="wishlistPublic"
                class="mr-2 h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary dark:bg-gray-700 dark:border-gray-600"
              />
              Make Public (Visible in Community Feed)
            </label>
          </div>
          <div class="mb-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
            <div class="flex items-center justify-between mb-2">
              <h4
                class="text-sm font-semibold text-gray-700 dark:text-gray-300"
              >
                Collaboration Mode
              </h4>
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="enableCollaboration"
                  class="sr-only peer"
                />
                <div
                  class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-secondary"
                ></div>
              </label>
            </div>
            <div id="collaborationOptions" class="hidden">
              <div class="mb-2">
                <label
                  class="block text-xs text-gray-600 dark:text-gray-400 mb-1"
                  >Access Type</label
                >
                <select
                  id="collaborationType"
                  class="w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-primary dark:bg-gray-800 dark:border-gray-600 dark:text-white"
                >
                  <option value="public">Anyone with the link</option>
                  <option value="invite">Invite only</option>
                </select>
              </div>
              <div class="mb-2">
                <label
                  class="block text-xs text-gray-600 dark:text-gray-400 mb-1"
                  >Contribution Tracking</label
                >
                <select
                  id="contributionTracking"
                  class="w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-primary dark:bg-gray-800 dark:border-gray-600 dark:text-white"
                >
                  <option value="tracked">Track who gifted what</option>
                  <option value="anonymous">Anonymous contributions</option>
                </select>
              </div>
              <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                <p>
                  <i class="fas fa-info-circle mr-1"></i>Collaboration allows
                  multiple people to contribute to this wishlist
                </p>
              </div>
            </div>
          </div>
        </form>
        <div class="flex justify-end gap-4">
          <button
            id="cancelCreateWishlist"
            class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-300"
          >
            Cancel
          </button>
          <button
            id="saveNewWishlist"
            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition duration-300"
          >
            <i class="fas fa-save mr-2"></i>Save Wishlist
          </button>
        </div>
      </div>
    </div>

    <script>
      function sendToast(text, type) {
        let style = {};
        const baseStyle = {
          borderRadius: "8px",
          fontFamily: '"Quicksand", sans-serif',
          fontWeight: "bold",
        };
        if (type === "success")
          style = { background: "linear-gradient(to right, #00b09b, #96c93d)" };
        else if (type === "error")
          style = { background: "linear-gradient(to right, #FF6B6B, #FF6B6B)" };
        else if (type === "info")
          style = { background: "linear-gradient(to right, #4ECDC4, #4ECDC4)" };
        else if (type === "warning")
          style = { background: "#FFE66D", color: "#333" };
        Toastify({
          text: text || "This is a toast",
          close: true,
          duration: 3000,
          gravity: "top",
          position: "center",
          stopOnFocus: true,
          style: { ...baseStyle, ...style },
        }).showToast();
      }

      function saveWishlistsToStorage() {
        try {
          localStorage.setItem("userWishlists", JSON.stringify(userWishlists));
        } catch (e) {
          console.error("Error saving wishlists to localStorage:", e);
        }
      }

      function triggerConfetti() {
        const canvas = document.getElementById("confetti-canvas");
        if (!canvas || typeof confetti === "undefined") return;
        const myConfetti = confetti.create(canvas, {
          resize: true,
          useWorker: true,
        });
        myConfetti({
          particleCount: 180,
          spread: 100,
          origin: { y: 0.6 },
          colors: [
            "#FF6B6B",
            "#4ECDC4",
            "#FFE66D",
            "#292F36",
            "#F7FFF7",
            "#FFFFFF",
          ],
          scalar: 1.2,
          gravity: 0.8,
        });
        setTimeout(
          () =>
            myConfetti({
              particleCount: 100,
              spread: 120,
              origin: { y: 0.4 },
              scalar: 0.8,
              gravity: 0.6,
            }),
          300
        );
      }

      function animatePlotlyFulfillment() {
        if (typeof Plotly === "undefined") return;
        let animDiv = document.getElementById("plotly-fulfillment-animation");
        if (!animDiv) {
          animDiv = document.createElement("div");
          animDiv.id = "plotly-fulfillment-animation";
          document.body.appendChild(animDiv);
        } else {
          Plotly.purge(animDiv);
        }

        const frames = [],
          n_frames = 20,
          n_points = 50,
          colors = ["#FF6B6B", "#4ECDC4", "#FFE66D", "#738FA7", "#FFFFFF"];
        for (let i = 0; i < n_frames; i++) {
          const x = Array(n_points)
              .fill()
              .map(() => Math.random() * 2 - 1),
            y = Array(n_points)
              .fill()
              .map(() => Math.random() * 2 - 1),
            size = Array(n_points)
              .fill()
              .map(() => Math.random() * 20 + 5),
            frame_colors = Array(n_points)
              .fill()
              .map(() => colors[Math.floor(Math.random() * colors.length)]);
          frames.push({
            name: `frame${i}`,
            data: [
              {
                x,
                y,
                mode: "markers",
                type: "scatter",
                marker: { size, color: frame_colors, opacity: 0.7 },
              },
            ],
          });
        }
        const layout = {
          title: "Wishlist Fulfilled!",
          xaxis: {
            showgrid: false,
            zeroline: false,
            showticklabels: false,
            range: [-1.2, 1.2],
          },
          yaxis: {
            showgrid: false,
            zeroline: false,
            showticklabels: false,
            range: [-1.2, 1.2],
          },
          paper_bgcolor: "rgba(0,0,0,0.1)",
          plot_bgcolor: "rgba(0,0,0,0)",
          showlegend: false,
          hovermode: false,
          font: { color: "#fff" },
        };
        if (!document.documentElement.classList.contains("dark"))
          layout.paper_bgcolor = "rgba(0,0,0,0.6)";
        Plotly.newPlot(animDiv, frames[0].data, layout, {
          displayModeBar: false,
          staticPlot: true,
        });
        Plotly.animate(animDiv, frames, {
          frame: { duration: 100, redraw: false },
          transition: { duration: 50, easing: "linear" },
          mode: "immediate",
        });
        setTimeout(() => {
          if (animDiv && animDiv.parentNode) {
            Plotly.purge(animDiv);
            animDiv.parentNode.removeChild(animDiv);
          }
        }, n_frames * 100 + 500);
      }

      const views = {
        explore: document.getElementById("explore"),
        community: document.getElementById("community"),
      };
      function showView(viewName) {
        const view = views[viewName];
        if (view) {
          document.querySelectorAll(".view").forEach((v) => {
            const isActive = v.id === viewName;
            v.classList.toggle("opacity-0", !isActive);
            v.classList.toggle("pointer-events-none", !isActive);
            v.classList.toggle("translate-x-full", !isActive);
            v.classList.toggle("opacity-100", isActive);
            v.classList.toggle("pointer-events-auto", isActive);
          });
          if (view) view.scrollTop = 0;
          if (viewName === "explore" && !editingWishlistId) {
            document.getElementById("wishlist-editor-title").textContent =
              "Create Your Wishlist";
          }
        }
      }

      function closeSidePanel() {
        document.getElementById("backDrop").classList.add("hidden");
        document.getElementById("sidePanel").classList.add("-translate-x-full");
      }

      const sampleProducts = [
        {
          id: 1,
          title: "Wireless Headphones",
          price: 99.99,
          category: "electronics",
          image:
            "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 2,
          title: "Smart Watch",
          price: 199.99,
          category: "electronics",
          image:
            "https://images.unsplash.com/photo-1523275335684-37898b6baf30?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 3,
          title: "Coffee Maker",
          price: 79.99,
          category: "home",
          image:
            "https://images.unsplash.com/photo-1550583724-b2692b85b150?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 4,
          title: "Yoga Mat",
          price: 29.99,
          category: "fitness",
          image:
            "https://images.unsplash.com/photo-1576678927484-cc907957088c?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 5,
          title: "Novel - Best Seller",
          price: 14.99,
          category: "books",
          image:
            "https://images.unsplash.com/photo-1544947950-fa07a98d237f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 6,
          title: "Blender",
          price: 49.99,
          category: "home",
          image:
            "https://images.unsplash.com/photo-1560343090-f0409e92791a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 7,
          title: "Running Shoes",
          price: 89.99,
          category: "fashion",
          image:
            "https://images.unsplash.com/photo-1460353581641-37baddab0fa2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 8,
          title: "Board Game",
          price: 39.99,
          category: "toys",
          image:
            "https://images.unsplash.com/photo-1608889825205-eebdb9fc5806?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 9,
          title: "Bluetooth Speaker",
          price: 59.99,
          category: "electronics",
          image:
            "https://images.unsplash.com/photo-1572569511254-d8f925fe2cbb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 10,
          title: "Electric Kettle",
          price: 34.99,
          category: "home",
          image:
            "https://images.unsplash.com/photo-1738520420652-0c47cea3922b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 11,
          title: "Fitness Tracker",
          price: 129.99,
          category: "fitness",
          image:
            "https://images.unsplash.com/photo-1576243345690-4e4b79b63288?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 12,
          title: "Sci-Fi Novel",
          price: 19.99,
          category: "books",
          image:
            "https://images.unsplash.com/photo-1589998059171-988d887df646?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 13,
          title: "Leather Wallet",
          price: 24.99,
          category: "fashion",
          image:
            "https://images.unsplash.com/photo-1590874103328-eac38a683ce7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 14,
          title: "Action Figure Set",
          price: 44.99,
          category: "toys",
          image:
            "https://images.unsplash.com/photo-1596462502278-27bfdc403348?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 15,
          title: "Tablet",
          price: 249.99,
          category: "electronics",
          image:
            "https://images.unsplash.com/photo-1546054454-aa26e2b734c7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 16,
          title: "Air Purifier",
          price: 149.99,
          category: "home",
          image:
            "https://images.unsplash.com/photo-1581578731548-c64695cc6952?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 17,
          title: "Resistance Bands",
          price: 19.99,
          category: "fitness",
          image:
            "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 18,
          title: "Cookbook",
          price: 22.99,
          category: "books",
          image:
            "https://images.unsplash.com/photo-1544947950-fa07a98d237f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 19,
          title: "Denim Jacket",
          price: 69.99,
          category: "fashion",
          image:
            "https://images.unsplash.com/photo-1591047139829-d91aecb6caea?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
        {
          id: 20,
          title: "Lego Set",
          price: 59.99,
          category: "toys",
          image:
            "https://images.unsplash.com/photo-1600267165477-6d4cc741b379?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&h=150&q=80",
        },
      ];
      let sampleWishlists = JSON.parse(
        JSON.stringify([
          {
            id: 1,
            title: "Birthday Wishes",
            author: "Jane Doe",
            items: [sampleProducts[0], sampleProducts[2], sampleProducts[4]],
            claimed: [sampleProducts[0].id],
            likes: 24,
            comments: 5,
            fulfilled: false,
            isPublic: true,
            collaborative: true,
            collaborationSettings: {
              type: "public",
              tracking: "tracked",
            },
            contributors: [
              {
                name: "Michael Brown",
                avatar: "MB",
                contributed: [sampleProducts[0].id],
              },
            ],
            created: new Date(2025, 4, 1).toISOString(),
          },
          {
            id: 2,
            title: "Housewarming Gifts",
            author: "John Smith",
            items: [sampleProducts[1], sampleProducts[3], sampleProducts[5]],
            claimed: [],
            likes: 15,
            comments: 3,
            fulfilled: false,
            isPublic: true,
            collaborative: false,
            created: new Date(2025, 4, 5).toISOString(),
          },
          {
            id: 3,
            title: "Holiday Wishlist",
            author: "Alex Johnson",
            items: [sampleProducts[6], sampleProducts[7], sampleProducts[2]],
            claimed: [sampleProducts[6].id],
            likes: 32,
            comments: 8,
            fulfilled: false,
            isPublic: false,
            collaborative: false,
            created: new Date(2025, 3, 20).toISOString(),
          },
          {
            id: 4,
            title: "Baby Shower",
            author: "Emily Wilson",
            items: [sampleProducts[3], sampleProducts[5], sampleProducts[7]],
            claimed: [sampleProducts[3].id, sampleProducts[7].id],
            likes: 42,
            comments: 12,
            fulfilled: true,
            isPublic: true,
            collaborative: true,
            collaborationSettings: {
              type: "invite",
              tracking: "anonymous",
            },
            contributors: [
              {
                name: "Sarah Chen",
                avatar: "SC",
                contributed: [sampleProducts[3].id],
              },
              {
                name: "David Lopez",
                avatar: "DL",
                contributed: [sampleProducts[7].id],
              },
            ],
            created: new Date(2025, 4, 10).toISOString(),
          },
          {
            id: 5,
            title: "Gadget Goals",
            author: "Tech Guru",
            items: [sampleProducts[1], sampleProducts[8], sampleProducts[14]],
            claimed: [],
            likes: 55,
            comments: 10,
            fulfilled: false,
            isPublic: true,
            collaborative: false,
            created: new Date(2025, 4, 8).toISOString(),
          },
        ])
      );

      const menuButton = document.getElementById("menu");
      const backDrop = document.getElementById("backDrop");
      const productsContainer = document.getElementById("products");
      const wishlistContainer = document.getElementById("wishlist");
      const trendsContainer = document.getElementById("trends-container");
      const noListText = document.getElementById("noListText");
      const shareWishList = document.getElementById("shareWishList");
      const resetWishList = document.getElementById("resetWishList");
      const saveWishlistBtn = document.getElementById("saveWishlistBtn");
      const productSearch = document.getElementById("product-search");
      const searchBtn = document.getElementById("search-btn");
      const communityWishListsContainer =
        document.getElementById("communityWishLists");
      const totalWishlistsChart = document.getElementById(
        "total-wishlists-chart"
      );
      const categoriesChart = document.getElementById("categories-chart");
      const progressFill = document.getElementById("progress-fill");
      const progressPercent = document.getElementById("progress-percent");
      const fulfillBtn = document.getElementById("fulfill-btn");
      const categoryFilter = document.getElementById("category-filter");
      const sortFilter = document.getElementById("sort-filter");
      const themeToggle = document.getElementById("themeToggle");
      const resetModal = document.getElementById("resetModal");
      const cancelReset = document.getElementById("cancelReset");
      const confirmReset = document.getElementById("confirmReset");
      const viewWishlistModal = document.getElementById("viewWishlistModal");
      const closeViewWishlist = document.getElementById("closeViewWishlist");
      const createWishlistModal = document.getElementById(
        "createWishlistModal"
      );
      const closeCreateWishlist = document.getElementById(
        "closeCreateWishlist"
      );
      const cancelCreateWishlist = document.getElementById(
        "cancelCreateWishlist"
      );
      const saveNewWishlist = document.getElementById("saveNewWishlist");
      const savedWishlistsContainer = document.getElementById(
        "savedWishlistsContainer"
      );
      const noSavedWishlistText = document.getElementById(
        "noSavedWishlistText"
      );

      let currentWishList = [];
      let userWishlists = [];
      let isFulfilling = false;
      let activeFilterCategory = "all";
      let currentSearchQuery = "";
      let wishlistSortable = null;
      let editingWishlistId = null;
      let productPopularity = null;

      function updateProgress() {
        const totalItems = currentWishList.length;
        const claimedItems = currentWishList.filter(
          (item) => item.claimed
        ).length;

        const isEmpty = totalItems === 0;
        resetWishList.disabled = isEmpty;
        resetWishList.classList.toggle("opacity-50", isEmpty);
        resetWishList.classList.toggle("cursor-not-allowed", isEmpty);
        resetWishList.title = isEmpty
          ? "Wishlist is empty"
          : "Reset current wishlist editor";

        const progress =
          totalItems > 0 ? Math.round((claimedItems / totalItems) * 100) : 0;
        progressFill.style.width = `${progress}%`;
        progressPercent.textContent = progress;

        if (progress === 100 && totalItems > 0) {
          fulfillBtn.classList.remove("hidden");
        } else {
          fulfillBtn.classList.add("hidden");
        }
      }

      function toggleDarkMode() {
        const isDark = document.documentElement.classList.toggle("dark");
        localStorage.setItem("darkMode", isDark);
        setTimeout(updateCharts, 100);
      }

      function updateCharts() {
        if (typeof Plotly === "undefined") return;
        try {
          initTrendsChart();
          initStatsCharts();
        } catch (error) {
          console.error("Error updating charts:", error);
        }
      }

      function renderProductCard(product) {
        const card = document.createElement("div");
        card.className = "product-card";
        card.dataset.productId = product.id;

        card.innerHTML = `
            <img src="${product.image}" alt="${product.title}" class="w-full h-36 object-cover rounded-lg mb-2" loading="lazy">
            <h3 class="text-sm font-semibold text-center dark:text-gray-200 flex-grow px-1">${product.title}</h3>
            <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">$${product.price.toFixed(2)}</p>
            <button class="add-to-wishlist-btn bg-secondary text-white text-xs px-2 py-1 rounded mt-2 hover:bg-primary transition" data-id="${product.id}">
            <i class="fas fa-plus mr-1"></i>Add to Wishlist
            </button>
        `;
        return card;
      }

      function renderProducts(productsToRender) {
        productsContainer.innerHTML = "";
        if (!productsToRender || productsToRender.length === 0) {
          productsContainer.innerHTML = `<div class="w-full h-full flex flex-col items-center justify-center p-10 text-center"><i class="fas fa-box-open text-4xl text-gray-400 mb-4"></i><p class="text-gray-500 dark:text-gray-400">No products found matching your criteria.</p></div>`;
          return;
        }
        productsToRender.forEach((p) =>
          productsContainer.appendChild(renderProductCard(p))
        );
      }

      function filterAndRenderProducts() {
        let filtered = sampleProducts;
        if (activeFilterCategory !== "all") {
          filtered = filtered.filter(
            (p) => p.category === activeFilterCategory
          );
        }
        if (currentSearchQuery) {
          const query = currentSearchQuery.toLowerCase();
          filtered = filtered.filter(
            (p) =>
              p.title.toLowerCase().includes(query) ||
              p.category.toLowerCase().includes(query)
          );
        }
        renderProducts(filtered);
      }

      function handleCategoryFilterClick(e) {
        const button = e.target.closest(".category-btn");
        if (!button) return;
        activeFilterCategory = button.getAttribute("data-category");
        document.querySelectorAll(".category-btn").forEach((btn) => {
          const isSelected = btn === button;
          btn.classList.toggle("bg-primary", isSelected);
          btn.classList.toggle("text-white", isSelected);
          btn.classList.toggle("bg-gray-200", !isSelected);
          btn.classList.toggle("text-gray-800", !isSelected);
          btn.classList.toggle("dark:bg-gray-700", !isSelected);
          btn.classList.toggle("dark:text-white", !isSelected);
        });
        filterAndRenderProducts();
      }

      function handleSearch() {
        currentSearchQuery = productSearch.value.trim();
        filterAndRenderProducts();
      }

      function loadWishList() {
        wishlistContainer.innerHTML = "";
        const hasItems = currentWishList.length > 0;
        noListText.classList.toggle("hidden", hasItems);
        noListText.classList.toggle("flex", !hasItems);

        currentWishList.forEach((item) => {
          const wrapper = document.createElement("div");
          wrapper.className = "product-card wishlist-item-card";
          wrapper.dataset.id = item.id;

          wrapper.innerHTML = `
                 <img src="${item.image}" alt="${item.title}" class="w-full h-24 object-cover rounded-lg mb-2 cursor-move" loading="lazy">
                 <h3 class="text-xs font-semibold text-center dark:text-gray-200 flex-grow px-1">${item.title}</h3>
             `;

          const priceP = document.createElement("p");
          priceP.className = "text-gray-500 dark:text-gray-400 text-xs";
          priceP.textContent = `$${item.price.toFixed(2)}`;

          const delBtn = document.createElement("button");
          delBtn.innerHTML = '<i class="fas fa-times"></i>';
          delBtn.className =
            "absolute top-1 right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center hover:bg-red-700 transition duration-300 text-xs z-10";
          delBtn.title = "Remove";
          delBtn.onclick = (e) => {
            e.stopPropagation();
            currentWishList = currentWishList.filter((i) => i.id !== item.id);
            loadWishList();
          };
          wrapper.appendChild(delBtn);

          const claimCont = document.createElement("div");

          function renderClaimStatus() {
            claimCont.innerHTML = "";
            if (item.claimed) {
              const claimedStatus = document.createElement("button");
              claimedStatus.innerHTML = '<i class="fas fa-check"></i>Claimed';
              claimedStatus.className = "claimed-status-btn";
              claimedStatus.title = "Click to unclaim this item";
              claimedStatus.onclick = (e) => {
                e.stopPropagation();
                item.claimed = false;
                renderClaimStatus();
                updateProgress();
                if (editingWishlistId) {
                  saveWishlistsToStorage();
                }
              };
              claimCont.appendChild(claimedStatus);
            } else {
              const claimBtn = document.createElement("button");
              claimBtn.innerHTML = '<i class="fas fa-gift mr-1"></i>Claim';
              claimBtn.className =
                "bg-primary text-white rounded-full px-2 py-0.5 hover:bg-secondary transition duration-300 text-xs";
              claimBtn.title = "Mark as claimed";
              claimBtn.onclick = (e) => {
                e.stopPropagation();
                item.claimed = true;
                renderClaimStatus();
                updateProgress();
                if (editingWishlistId) {
                  saveWishlistsToStorage();
                }
              };
              claimCont.appendChild(claimBtn);
            }
          }
          renderClaimStatus();

          const bottomRow = document.createElement("div");
          bottomRow.className =
            "flex justify-between items-center w-full mt-auto pt-1 px-1";
          bottomRow.appendChild(priceP);
          bottomRow.appendChild(claimCont);
          wrapper.appendChild(bottomRow);

          wishlistContainer.appendChild(wrapper);
        });

        updateProgress();

        if (wishlistSortable) {
          wishlistSortable.destroy();
        }
        if (Sortable && wishlistContainer) {
          wishlistSortable = new Sortable(wishlistContainer, {
            group: {
              name: "shared",
              put: true,
            },
            animation: 150,
            ghostClass: "sortable-ghost",
            dragClass: "sortable-drag",
            onAdd: function (evt) {
              const itemEl = evt.item;
              const productId = parseInt(itemEl.dataset.productId);
              const productData = sampleProducts.find((p) => p.id === productId);

              if (itemEl.parentNode) {
                itemEl.parentNode.removeChild(itemEl);
              }

              if (productData) {
                if (
                  !currentWishList.some((item) => item.id === productData.id)
                ) {
                  const newItem = { ...productData, claimed: false };
                  currentWishList.splice(evt.newIndex, 0, newItem);
                  loadWishList();
                  sendToast(
                    `"${productData.title}" added to your wishlist!`,
                    "success"
                  );
                } else {
                  sendToast(
                    `"${productData.title}" is already in your wishlist.`,
                    "warning"
                  );
                  loadWishList();
                }
              } else {
                loadWishList();
              }
            },
            onEnd: (evt) => {
              if (evt.from === evt.to) {
                const movedItemId = parseInt(evt.item.dataset.id);
                const itemToMove = currentWishList.find(
                  (i) => i.id === movedItemId
                );
                if (itemToMove) {
                  currentWishList.splice(evt.oldIndex, 1);
                  currentWishList.splice(evt.newIndex, 0, itemToMove);
                  if (editingWishlistId) {
                    saveWishlistsToStorage();
                  }
                }
              }
            },
          });
        }
      }

      function clearWishlistEditor() {
        currentWishList = [];
        editingWishlistId = null;
        loadWishList();
        document.getElementById("wishlist-editor-title").textContent =
          "Create Your Wishlist";
      }

      function loadUserWishlists() {
        savedWishlistsContainer.innerHTML = "";
        const hasSaved = userWishlists.length > 0;
        noSavedWishlistText.classList.toggle("hidden", hasSaved);
        noSavedWishlistText.classList.toggle("flex", !hasSaved);
        if (!hasSaved) return;

        const sorted = [...userWishlists].sort(
          (a, b) => new Date(b.created) - new Date(a.created)
        );

        sorted.forEach((wishlist) => {
          const card = document.createElement("div");
          card.className =
            "relative feed-wishlist-card flex flex-col justify-between min-h-[340px] flex-shrink-0 snap-start";
          if (wishlist.fulfilled) {
            card.classList.add("border-2", "border-accent");
          }

          const claimedIds = Array.isArray(wishlist.claimed)
            ? wishlist.claimed
            : [];

          const collaborativeIcon = wishlist.collaborative
            ? `<span class="ml-2 text-secondary" title="Group Gifting Enabled"><i class="fas fa-users"></i></span>`
            : "";

          const contributorsText =
            wishlist.collaborative &&
            wishlist.contributors &&
            wishlist.contributors.length > 0
              ? `<div class="text-xs text-secondary mt-1"><i class="fas fa-user-group mr-1"></i>${
                  wishlist.contributors.length
                } contributor${
                  wishlist.contributors.length > 1 ? "s" : ""
                }</div>`
              : "";

          const itemsHtml =
            wishlist.items && wishlist.items.length > 0
              ? wishlist.items
                  .slice(0, 4)
                  .map(
                    (i) => `
                      <div class="feed-item relative">
                          <img src="${i.image}" alt="${
                      i.title
                    }" class="w-full h-full object-cover" loading="lazy">
                          ${
                            claimedIds.includes(i.id)
                              ? '<div class="feed-item-claimed"><i class="fas fa-check"></i></div>'
                              : ""
                          }
                      </div>
                  `
                  )
                  .join("")
              : `<div class="col-span-2 w-full h-full flex items-center justify-center text-gray-400"><i class="fas fa-gift text-4xl"></i><p class="ml-2 text-sm">Empty</p></div>`;

          const deleteBtnHTML = `
            <button class="deleteUserWishlist absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-700 transition duration-300 text-xs z-10" data-id="${wishlist.id}" title="Delete">
                <i class="fas fa-trash"></i>
            </button>
            `;

          card.innerHTML = `
                  ${deleteBtnHTML}
                  <div class="feed-card-header">
                      <div class="feed-card-title dark:text-gray-200 flex items-center">
                        ${wishlist.title}${collaborativeIcon}
                      </div>
                      <div class="feed-card-author dark:text-gray-400">by ${
                        wishlist.author
                      } (${wishlist.isPublic ? "Public" : "Private"})</div>
                      ${
                        wishlist.fulfilled
                          ? '<div class="text-xs text-accent font-bold mt-1">FULFILLED!</div>'
                          : ""
                      }
                      ${contributorsText}
                  </div>
                  <div class="feed-card-body">${itemsHtml}</div>
                  <div class="feed-card-footer">
                      <div class="feed-card-stats">
                          <div class="feed-stat dark:text-gray-400" title="Items"><i class="fas fa-list-ul"></i> ${
                            wishlist.items ? wishlist.items.length : 0
                          }</div>
                          <div class="feed-stat dark:text-gray-400" title="Claimed"><i class="fas fa-check-double"></i> ${
                            claimedIds.length
                          }</div>
                          <div class="feed-stat dark:text-gray-400" title="Created"><i class="fas fa-calendar-alt"></i> ${new Date(
                            wishlist.created
                          ).toLocaleDateString()}</div>
                      </div>
                      <button class="editUserWishlist px-3 py-1 bg-secondary text-white rounded-lg hover:bg-primary transition duration-300 text-sm" data-id="${
                        wishlist.id
                      }">
                          <i class="fas fa-pencil-alt mr-1"></i> Edit
                    </button>
                  </div>
              `;
          savedWishlistsContainer.appendChild(card);
        });

        document
          .querySelectorAll(".editUserWishlist")
          .forEach((b) => b.addEventListener("click", handleEditUserWishlist));

        document.querySelectorAll(".deleteUserWishlist").forEach((b) =>
          b.addEventListener("click", function () {
            const id = parseInt(b.dataset.id);
            userWishlists = userWishlists.filter((w) => w.id !== id);
            saveWishlistsToStorage();
            loadUserWishlists();
            sendToast("Wishlist deleted successfully.", "success");
          })
        );
      }

      function handleEditUserWishlist(e) {
        const button = e.target.closest("button");
        if (!button) return;
        const id = parseInt(button.getAttribute("data-id"));
        const selected = userWishlists.find((w) => w.id === id);

        if (selected) {
          sendToast(`Loading "${selected.title}" for editing...`, "info");
          currentWishList = JSON.parse(JSON.stringify(selected.items)).map(
            (item) => ({
              ...item,
              claimed:
                Array.isArray(selected.claimed) &&
                selected.claimed.includes(item.id),
            })
          );
          editingWishlistId = selected.id;
          loadWishList();

          const editorTitle = document.getElementById("wishlist-editor-title");
          editorTitle.textContent = `Editing: ${selected.title}`;

          document
            .getElementById("wishlist-editor-section")
            .scrollIntoView({ behavior: "smooth" });
        } else {
          sendToast("Error: Could not find wishlist to edit.", "error");
          editingWishlistId = null;
        }
      }

      function filterCommunityWishlists(list) {
        const category = categoryFilter.value;
        const sort = sortFilter.value;
        let filtered = list.filter((w) => w.isPublic);

        if (category !== "all") {
          filtered = filtered.filter((w) =>
            w.items.some((i) => i.category === category)
          );
        }

        switch (sort) {
          case "popular":
            filtered.sort((a, b) => (b.likes || 0) - (a.likes || 0));
            break;
          case "recent":
            filtered.sort((a, b) => new Date(b.created) - new Date(a.created));
            break;
          case "fulfilled":
            filtered.sort((a, b) => {
              if (a.fulfilled !== b.fulfilled) {
                return b.fulfilled ? 1 : -1;
              }
              return new Date(b.created) - new Date(a.created);
            });
            break;
        }
        return filtered;
      }

      function loadCommunityWishLists() {
        communityWishListsContainer.innerHTML = "";
        const filteredAndSorted = filterCommunityWishlists(sampleWishlists);

        if (filteredAndSorted.length === 0) {
          communityWishListsContainer.innerHTML = `<div class="w-full flex flex-col items-center justify-center p-10 text-center"><i class="fas fa-ghost text-4xl text-gray-400 mb-4"></i><p class="text-gray-500 dark:text-gray-400">No public wishlists found matching your filters.</p></div>`;
          return;
        }

        filteredAndSorted.forEach((w) => {
          const card = document.createElement("div");
          card.className = "feed-wishlist-card flex-shrink-0 snap-start";
          if (w.fulfilled) {
            card.classList.add("border-2", "border-accent");
          }

          const claimedIds = Array.isArray(w.claimed) ? w.claimed : [];

          const collaborativeIcon = w.collaborative
            ? `<span class="ml-2 text-secondary" title="Group Gifting Enabled"><i class="fas fa-users"></i></span>`
            : "";

          const contributorsText =
            w.collaborative && w.contributors && w.contributors.length > 0
              ? `<div class="text-xs text-secondary mt-1"><i class="fas fa-user-group mr-1"></i>${
                  w.contributors.length
                } contributor${w.contributors.length > 1 ? "s" : ""}</div>`
              : "";

          const itemsHtml =
            w.items
              .slice(0, 4)
              .map(
                (i) => `
                <div class="feed-item relative">
                    <img src="${i.image}" alt="${
                  i.title
                }" class="w-full h-full object-cover" loading="lazy">
                    ${
                      claimedIds.includes(i.id)
                        ? '<div class="feed-item-claimed"><i class="fas fa-check"></i></div>'
                        : ""
                    }
                </div>
            `
              )
              .join("") ||
            `<div class="col-span-2 w-full h-full flex items-center justify-center text-gray-400"><i class="fas fa-gift text-4xl"></i></div>`;

          card.innerHTML = `
                <div class="feed-card-header">
                    <div class="feed-card-title dark:text-gray-200 flex items-center">
                      ${w.title}${collaborativeIcon}
                    </div>
                    <div class="feed-card-author dark:text-gray-400">by ${
                      w.author
                    }</div>
                    ${
                      w.fulfilled
                        ? '<div class="text-xs text-accent font-bold mt-1">FULFILLED!</div>'
                        : ""
                    }
                    ${contributorsText}
                </div>
                <div class="feed-card-body">${itemsHtml}</div>
                <div class="feed-card-footer">
                    <div class="feed-card-stats">
                        <div class="feed-stat dark:text-gray-400" title="Likes"><i class="fas fa-heart text-red-500"></i> ${
                          w.likes || 0
                        }</div>
                        <div class="feed-stat dark:text-gray-400" title="Comments"><i class="fas fa-comment text-blue-500"></i> ${
                          w.comments || 0
                        }</div>
                        <div class="feed-stat dark:text-gray-400" title="Items/Claimed"><i class="fas fa-tasks text-green-500"></i> ${
                          w.items.length
                        }/${claimedIds.length}</div>
                    </div>
                    <button class="viewCommunityWishlist px-3 py-1 bg-primary text-white rounded-lg hover:bg-secondary transition duration-300 text-sm" data-id="${
                      w.id
                    }">
                        <i class="fas fa-eye mr-1"></i> View
                    </button>
                </div>
            `;
          communityWishListsContainer.appendChild(card);
        });

        document
          .querySelectorAll(".viewCommunityWishlist")
          .forEach((b) =>
            b.addEventListener("click", handleViewCommunityWishlist)
          );
      }

      function handleViewCommunityWishlist(e) {
        const button = e.target.closest("button");
        if (!button) return;
        const id = parseInt(button.getAttribute("data-id"));
        const selected = sampleWishlists.find((w) => w.id === id);
        if (selected) {
          viewWishlistModalLogic(selected);
        } else {
          sendToast("Error: Could not find wishlist data.", "error");
        }
      }

      function viewWishlistModalLogic(wishlist) {
        document.getElementById("viewWishlistTitle").textContent =
          wishlist.title;
        document.getElementById("viewWishlistAuthor").textContent = `By ${
          wishlist.author
        } on ${new Date(wishlist.created).toLocaleDateString()}`;

        const itemsContainer = document.getElementById("viewWishlistItems");
        itemsContainer.innerHTML = "";

        const claimedIds = Array.isArray(wishlist.claimed)
          ? wishlist.claimed
          : [];

        const notCollaborative = document.getElementById("notCollaborative");
        const collaborativeWishlist = document.getElementById(
          "collaborativeWishlist"
        );
        const contributeWishlist =
          document.getElementById("contributeWishlist");
        const shareCollabLink = document.getElementById("shareCollabLink");

        if (wishlist.collaborative) {
          notCollaborative.classList.add("hidden");
          collaborativeWishlist.classList.remove("hidden");
          contributeWishlist.disabled = false;
          shareCollabLink.classList.remove("hidden");

          document.getElementById("collabType").textContent =
            wishlist.collaborationSettings?.type === "invite"
              ? "Invite-only"
              : "Open";

          const contributorsArea = document.getElementById("contributorsArea");
          contributorsArea.innerHTML = "";

          if (wishlist.contributors && wishlist.contributors.length > 0) {
            wishlist.contributors.forEach((contributor) => {
              const avatarChip = document.createElement("div");
              avatarChip.className =
                "flex items-center bg-gray-200 dark:bg-gray-700 rounded-full px-3 py-1 text-xs";
              avatarChip.innerHTML = `
                <div class="w-5 h-5 flex items-center justify-center bg-primary text-white rounded-full mr-1">
                  ${contributor.avatar}
                </div>
                <span class="dark:text-gray-200">${contributor.name}</span>
              `;
              contributorsArea.appendChild(avatarChip);
            });

            if (wishlist.contributors.length > 3) {
              const total = document.createElement("div");
              total.className = "text-xs text-gray-500 dark:text-gray-400 ml-1";
              total.textContent = `${wishlist.contributors.length} contributors total`;
              contributorsArea.appendChild(total);
            }
          } else {
            contributorsArea.innerHTML =
              "<p class='text-xs text-gray-500 dark:text-gray-400'>No contributors yet</p>";
          }
        } else {
          notCollaborative.classList.remove("hidden");
          collaborativeWishlist.classList.add("hidden");
          contributeWishlist.disabled = true;
          shareCollabLink.classList.add("hidden");
        }

        wishlist.items.forEach((item) => {
          const card = document.createElement("div");
          card.className =
            "bg-gray-50 dark:bg-gray-700 rounded-lg overflow-hidden shadow relative";
          const isClaimed = claimedIds.includes(item.id);

          card.innerHTML = `
            <img src="${item.image}" alt="${
            item.title
          }" class="w-full h-32 object-cover" loading="lazy">
            <div class="p-2">
                <h4 class="font-semibold dark:text-gray-200 text-xs truncate">${
                  item.title
                }</h4>
                <p class="text-gray-500 dark:text-gray-400 text-xs">$${item.price.toFixed(
                  2
                )}</p>
            </div>
            <div class="absolute bottom-1 right-1 claim-status-container"></div> `;

          const claimCont = card.querySelector(".claim-status-container");

          function renderClaimStatusInModal() {
            claimCont.innerHTML = "";

            let contributorInfo = "";
            if (
              wishlist.collaborative &&
              isClaimed &&
              wishlist.collaborationSettings?.tracking === "tracked"
            ) {
              const contributor = wishlist.contributors?.find(
                (c) => c.contributed && c.contributed.includes(item.id)
              );
              if (contributor) {
                contributorInfo = `<span class="text-xxs block mt-1">by ${contributor.name}</span>`;
              }
            }

            if (isClaimed) {
              claimCont.innerHTML = `<div class="bg-green-500 text-white rounded-full px-2 py-0.5 text-xs font-semibold flex flex-col items-center"><i class="fas fa-check mr-1"></i>Gifted${contributorInfo}</div>`;
            } else {
              const giftBtn = document.createElement("button");
              giftBtn.className =
                "claimItemBtn bg-secondary text-white rounded-full px-2 py-0.5 text-xs hover:bg-primary transition duration-300";
              giftBtn.dataset.itemId = item.id;
              giftBtn.dataset.wishlistId = wishlist.id;
              giftBtn.title = "Mark this as gifted";
              giftBtn.innerHTML = '<i class="fas fa-gift mr-1"></i>Gift It';
              giftBtn.onclick = handleClaimItemClick;
              claimCont.appendChild(giftBtn);
            }
          }
          renderClaimStatusInModal();
          itemsContainer.appendChild(card);
        });

        document.getElementById("contributeWishlist").onclick = function () {
          if (!wishlist.collaborative) return;

          const newContributor = {
            name: "You (Simulated)",
            avatar: "YS",
            contributed: [],
          };

          if (!wishlist.contributors) wishlist.contributors = [];

          const isAlreadyContributor = wishlist.contributors.some(
            (c) => c.name === newContributor.name
          );

          if (!isAlreadyContributor) {
            wishlist.contributors.push(newContributor);
            sendToast("You've joined as a group contributor!", "success");
            viewWishlistModalLogic(wishlist);
          } else {
            sendToast("You're already a contributor to this wishlist", "info");
          }
        };

        document.getElementById("shareCollabLink").onclick = function () {
          if (!wishlist.collaborative) return;

          const shareText = `Join me in contributing to "${wishlist.title}" wishlist on GiftWish! ${wishlist.items.length} items, ${claimedIds.length} already gifted.`;

          navigator.clipboard.writeText(shareText).then(
            () =>
              sendToast("Collaboration link copied to clipboard!", "success"),
            () => sendToast("Failed to copy link. Please try again.", "error")
          );
        };

        viewWishlistModal.classList.remove("hidden");
        viewWishlistModal.classList.add("flex");
      }

      function handleClaimItemClick(e) {
        const btn = e.target.closest("button");
        if (!btn) return;
        const itemId = parseInt(btn.dataset.itemId);
        const wishlistId = parseInt(btn.dataset.wishlistId);

        const targetWishlist = sampleWishlists.find((w) => w.id === wishlistId);
        const targetItem = targetWishlist?.items.find((i) => i.id === itemId);

        if (targetWishlist && targetItem) {
          if (!Array.isArray(targetWishlist.claimed)) {
            targetWishlist.claimed = [];
          }
          if (!targetWishlist.claimed.includes(itemId)) {
            targetWishlist.claimed.push(itemId);

            if (targetWishlist.collaborative) {
              let contributor = null;

              if (!targetWishlist.contributors) {
                targetWishlist.contributors = [];
              }

              contributor = targetWishlist.contributors.find(
                (c) => c.name === "You (Simulated)"
              );

              if (!contributor) {
                contributor = {
                  name: "You (Simulated)",
                  avatar: "YS",
                  contributed: [],
                };
                targetWishlist.contributors.push(contributor);
              }

              if (!contributor.contributed) {
                contributor.contributed = [];
              }

              contributor.contributed.push(itemId);
            }

            const cont = btn.closest(".claim-status-container");
            cont.innerHTML = `<div class="bg-green-500 text-white rounded-full px-2 py-0.5 text-xs font-semibold flex items-center"><i class="fas fa-check mr-1"></i>Gifted</div>`;
            btn.remove();

            sendToast(`"${targetItem.title}" marked as gifted!`, "success");

            loadCommunityWishLists();
            loadUserWishlists();
            initStatsCharts();

            viewWishlistModalLogic(targetWishlist);
          } else {
            sendToast(
              `"${targetItem.title}" was already marked as gifted.`,
              "info"
            );
            const cont = btn.closest(".claim-status-container");
            cont.innerHTML = `<div class="bg-green-500 text-white rounded-full px-2 py-0.5 text-xs font-semibold flex items-center"><i class="fas fa-check mr-1"></i>Gifted</div>`;
            btn.remove();
          }
        } else {
          sendToast(
            "Error marking item as gifted. Could not find data.",
            "error"
          );
          console.error(
            "Could not find wishlist or item to claim in handleClaimItemClick:",
            { wishlistId, itemId }
          );
        }
      }

      function initTrendsChart() {
        if (typeof Plotly === "undefined" || !trendsContainer) return;
        const chartDiv = document.getElementById("trends-chart");
        if (!chartDiv) return;

        const isDark = document.documentElement.classList.contains("dark");
        const txt = isDark ? "#E0E0E0" : "#333";
        const grid = isDark ? "rgba(255,255,255,0.1)" : "rgba(0,0,0,0.1)";
        const colors = [
          "#FF6B6B",
          "#4ECDC4",
          "#FFE66D",
          "#738FA7",
          "#F7FFF7",
          "#292F36",
        ];

        if (!productPopularity) {
          productPopularity = {};
          sampleProducts.forEach((p) => {
            productPopularity[p.category] =
              (productPopularity[p.category] || 0) +
              Math.floor(Math.random() * 50 + 10);
          });
        }

        const categoriesSorted = Object.entries(productPopularity).sort(
          ([, a], [, b]) => b - a
        );

        const data = [
          {
            x: categoriesSorted.map(
              ([category]) =>
                category.charAt(0).toUpperCase() + category.slice(1)
            ),
            y: categoriesSorted.map(([, popValue]) => popValue),
            type: "bar",
            marker: { color: colors },
            hovertemplate:
              "<b>%{x}</b><br>Popularity Score: %{y}<extra></extra>",
          },
        ];

        const layout = {
          title: { text: null },
          margin: { t: 20, b: 40, l: 40, r: 20 },
          xaxis: {
            color: txt,
            gridcolor: grid,
            tickfont: { family: '"Quicksand", sans-serif', size: 10 },
          },
          yaxis: {
            title: "Popularity Score",
            color: txt,
            gridcolor: grid,
            tickfont: { family: '"Quicksand", sans-serif', size: 10 },
          },
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)",
          font: { color: txt, family: '"Quicksand", sans-serif' },
          hoverlabel: {
            bgcolor: isDark ? "#4A4A4A" : "#FFFFFF",
            font: { size: 12 },
            borderradius: 4,
          },
          bargap: 0.2,
          autosize: true,
        };

        Plotly.react(chartDiv, data, layout, {
          displayModeBar: false,
          responsive: true,
        });
      }

      function initStatsCharts() {
        if (typeof Plotly === "undefined") return;
        const isDark = document.documentElement.classList.contains("dark");
        const txt = isDark ? "#E0E0E0" : "#333";
        const pieCols = [
          "#FF6B6B",
          "#4ECDC4",
          "#FFE66D",
          "#738FA7",
          "#F7FFF7",
          "#292F36",
        ];
        const bgColor = isDark ? "#121212" : "#FFFFFF";

        const userPublicIds = userWishlists
          .filter((w) => w.isPublic)
          .map((w) => w.id);
        const samplePublicNonUser = sampleWishlists.filter(
          (w) => w.isPublic && !userPublicIds.includes(w.id)
        );
        const publicCount = userPublicIds.length + samplePublicNonUser.length;
        const privateCount = userWishlists.filter((w) => !w.isPublic).length;
        const totalCount = publicCount + privateCount;

        const totalDiv = document.getElementById("total-wishlists-chart");
        if (totalDiv && totalCount > 0) {
          Plotly.react(
            totalDiv,
            [
              {
                values: [publicCount, privateCount],
                labels: ["Public", "Private"],
                type: "pie",
                hole: 0.6,
                marker: {
                  colors: [pieCols[1], pieCols[3]],
                  line: { width: 1, color: bgColor },
                },
                textfont: { color: txt },
                textinfo: "percent",
                insidetextorientation: "radial",
                hoverinfo: "label+value",
              },
            ],
            {
              title: {
                text: "Wishlist Visibility",
                font: { family: '"Fredoka", sans-serif', size: 16, color: txt },
                y: 0.9,
              },
              annotations: [
                {
                  font: { size: 18, color: txt },
                  showarrow: false,
                  text: totalCount,
                  x: 0.5,
                  y: 0.5,
                },
              ],
              margin: { t: 40, b: 40, l: 20, r: 20 },
              showlegend: true,
              legend: {
                orientation: "h",
                xanchor: "center",
                x: 0.5,
                y: -0.1,
                font: { color: txt, size: 10 },
              },
              paper_bgcolor: "rgba(0,0,0,0)",
              plot_bgcolor: "rgba(0,0,0,0)",
              autosize: true,
            },
            { responsive: true, displayModeBar: false }
          );
        } else if (totalDiv) {
          totalDiv.innerHTML =
            '<p class="text-center text-gray-500 dark:text-gray-400 p-4">No wishlist data for visibility chart.</p>';
        }

        const categoryCounts = {};
        const allPublicLists = [
          ...userWishlists.filter((w) => w.isPublic),
          ...samplePublicNonUser,
        ];
        allPublicLists.forEach((list) => {
          list.items.forEach((item) => {
            categoryCounts[item.category] =
              (categoryCounts[item.category] || 0) + 1;
          });
        });
        const categoriesSorted = Object.entries(categoryCounts)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 5);
        const labels = categoriesSorted.map(
          ([label]) => label.charAt(0).toUpperCase() + label.slice(1)
        );
        const values = categoriesSorted.map(([, value]) => value);

        const categoryDiv = document.getElementById("categories-chart");
        if (categoryDiv && values.length > 0) {
          Plotly.react(
            categoryDiv,
            [
              {
                values: values,
                labels: labels,
                type: "pie",
                hole: 0.6,
                marker: { colors: pieCols, line: { width: 1, color: bgColor } },
                textfont: { color: txt },
                textinfo: "percent",
                insidetextorientation: "radial",
                hoverinfo: "label+value",
              },
            ],
            {
              title: {
                text: "Top Item Categories (Public)",
                font: { family: '"Fredoka", sans-serif', size: 16, color: txt },
                y: 0.9,
              },
              annotations: [
                {
                  font: { size: 18, color: txt },
                  showarrow: false,
                  text: "Top 5",
                  x: 0.5,
                  y: 0.5,
                },
              ],
              margin: { t: 40, b: 40, l: 20, r: 20 },
              showlegend: true,
              legend: {
                orientation: "h",
                xanchor: "center",
                x: 0.5,
                y: -0.1,
                font: { color: txt, size: 10 },
              },
              paper_bgcolor: "rgba(0,0,0,0)",
              plot_bgcolor: "rgba(0,0,0,0)",
              autosize: true,
            },
            { responsive: true, displayModeBar: false }
          );
        } else if (categoryDiv) {
          categoryDiv.innerHTML =
            '<p class="text-center text-gray-500 dark:text-gray-400 p-4">No category data available.</p>';
        }
      }

      function initApp() {
        if (localStorage.getItem("darkMode") === "true") {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }

        if (Sortable && productsContainer) {
          new Sortable(productsContainer, {
            group: {
              name: "shared",
              pull: "clone",
              put: false,
            },
            animation: 150,
            sort: false,
          });
        }

        userWishlists = sampleWishlists.filter((w) =>
          ["Jane Doe", "Alex Johnson"].includes(w.author)
        );
        userWishlists = JSON.parse(JSON.stringify(userWishlists));

        try {
          const savedLists = localStorage.getItem("userWishlists");
          if (savedLists) {
            const parsedLists = JSON.parse(savedLists);
            if (Array.isArray(parsedLists) && parsedLists.length > 0) {
              userWishlists = parsedLists;
            }
          }
        } catch (e) {
          console.error("Error loading saved wishlists:", e);
        }

        loadUserWishlists();
        filterAndRenderProducts();
        loadCommunityWishLists();
        updateCharts();
        loadWishList();

        document
          .querySelectorAll(".category-btn")
          .forEach((b) =>
            b.addEventListener("click", handleCategoryFilterClick)
          );
        searchBtn.addEventListener("click", handleSearch);
        productSearch.addEventListener("keypress", (e) => {
          if (e.key === "Enter") handleSearch();
        });
        productSearch.addEventListener("input", () => {
          if (productSearch.value === "") handleSearch();
        });

        resetWishList.addEventListener("click", () => {
          if (currentWishList.length > 0) {
            resetModal.classList.remove("hidden");
            resetModal.classList.add("flex");
          } else {
            sendToast("Wishlist editor is already empty.", "info");
          }
        });
        saveWishlistBtn.addEventListener("click", () => {
          if (currentWishList.length === 0) {
            sendToast(
              "Add some items to your wishlist before saving!",
              "warning"
            );
            return;
          }
          document.getElementById("createWishlistForm").reset();
          if (editingWishlistId) {
            const list = userWishlists.find((w) => w.id === editingWishlistId);
            if (list) {
              document.getElementById("wishlistTitle").value = list.title;
              document.getElementById("wishlistDescription").value =
                list.description || "";
              document.getElementById("wishlistPublic").checked = list.isPublic;

              const enableCollabCheck = document.getElementById(
                "enableCollaboration"
              );
              enableCollabCheck.checked = list.collaborative || false;

              const changeEvent = new Event("change");
              enableCollabCheck.dispatchEvent(changeEvent);

              if (list.collaborative && list.collaborationSettings) {
                document.getElementById("collaborationType").value =
                  list.collaborationSettings.type || "public";
                document.getElementById("contributionTracking").value =
                  list.collaborationSettings.tracking || "tracked";
              }
            }
          }
          createWishlistModal.classList.remove("hidden");
          createWishlistModal.classList.add("flex");
        });
        shareWishList.addEventListener("click", () => {
          if (currentWishList.length > 0) {
            const listText = `My GiftWish List:\n${currentWishList
              .map(
                (item) => `- ${item.title} ${item.claimed ? "(Gifted!)" : ""}`
              )
              .join("\n")}`;
            navigator.clipboard.writeText(listText).then(
              () => {
                sendToast("Wishlist copied to clipboard!", "success");
              },
              (err) => {
                sendToast("Failed to copy list. Please try again.", "error");
                console.error("Clipboard copy failed: ", err);
              }
            );
          } else {
            sendToast("Your wishlist is empty!", "warning");
          }
        });
        fulfillBtn.addEventListener("click", () => {
          if (isFulfilling) return;
          isFulfilling = true;
          fulfillBtn.disabled = true;
          triggerConfetti();
          animatePlotlyFulfillment();
          sendToast("Woohoo! Wishlist marked fulfilled!", "success");
          setTimeout(() => {
            isFulfilling = false;
            fulfillBtn.disabled = false;
          }, 3500);
        });

        cancelReset.addEventListener("click", () => {
          resetModal.classList.add("hidden");
          resetModal.classList.remove("flex");
        });
        confirmReset.addEventListener("click", () => {
          clearWishlistEditor();
          resetModal.classList.add("hidden");
          resetModal.classList.remove("flex");
          sendToast("Wishlist editor cleared.", "info");
        });
        closeCreateWishlist.addEventListener("click", () => {
          createWishlistModal.classList.add("hidden");
          createWishlistModal.classList.remove("flex");
        });
        cancelCreateWishlist.addEventListener("click", () => {
          createWishlistModal.classList.add("hidden");
          createWishlistModal.classList.remove("flex");
        });
        saveNewWishlist.addEventListener("click", () => {
          const title = document.getElementById("wishlistTitle").value.trim();
          const description = document
            .getElementById("wishlistDescription")
            .value.trim();
          const isPublic = document.getElementById("wishlistPublic").checked;
          const isCollaborative = document.getElementById(
            "enableCollaboration"
          ).checked;

          let collaborationSettings = null;
          if (isCollaborative) {
            collaborationSettings = {
              type: document.getElementById("collaborationType").value,
              tracking: document.getElementById("contributionTracking").value,
            };
          }

          if (!title) {
            sendToast("Please enter a title for your wishlist.", "error");
            return;
          }

          const itemsToSave = currentWishList.map((i) => ({
            id: i.id,
            title: i.title,
            price: i.price,
            category: i.category,
            image: i.image,
          }));
          const claimedIds = currentWishList
            .filter((i) => i.claimed)
            .map((i) => i.id);
          const isFulfilled =
            itemsToSave.length > 0 && claimedIds.length === itemsToSave.length;

          if (editingWishlistId) {
            const listIndex = userWishlists.findIndex(
              (w) => w.id === editingWishlistId
            );
            if (listIndex > -1) {
              userWishlists[listIndex] = {
                ...userWishlists[listIndex],
                title: title,
                description: description,
                isPublic: isPublic,
                collaborative: isCollaborative,
                collaborationSettings: collaborationSettings,
                items: itemsToSave,
                claimed: claimedIds,
                fulfilled: isFulfilled,
              };
              sendToast(`Wishlist "${title}" updated!`, "success");
            } else {
              sendToast("Error: Could not find the list to update.", "error");
              editingWishlistId = null;
              return;
            }
          } else {
            const newList = {
              id: Date.now(),
              title: title,
              description: description,
              isPublic: isPublic,
              collaborative: isCollaborative,
              collaborationSettings: collaborationSettings,
              contributors: [],
              items: itemsToSave,
              claimed: claimedIds,
              created: new Date().toISOString(),
              author: "You",
              likes: 0,
              comments: 0,
              fulfilled: isFulfilled,
            };
            userWishlists.push(newList);
            sendToast(`Wishlist "${title}" saved!`, "success");
          }

          saveWishlistsToStorage();

          loadUserWishlists();
          clearWishlistEditor();
          createWishlistModal.classList.add("hidden");
          createWishlistModal.classList.remove("flex");

          setTimeout(() => {
            document
              .getElementById("savedWishlistsArea")
              .scrollIntoView({ behavior: "smooth" });
          }, 100);
        });
        closeViewWishlist.addEventListener("click", () => {
          viewWishlistModal.classList.add("hidden");
          viewWishlistModal.classList.remove("flex");
        });
        const contribBtn = document.getElementById("contributeWishlist");
        if (contribBtn) {
          contribBtn.onclick = () =>
            sendToast("Group contribution feature coming soon!", "info");
        }

        menuButton.addEventListener("click", () => {
          backDrop.classList.toggle("hidden");
          document
            .getElementById("sidePanel")
            .classList.toggle("-translate-x-full");
        });
        backDrop.addEventListener("click", closeSidePanel);

        themeToggle.addEventListener("click", toggleDarkMode);

        categoryFilter.addEventListener("change", loadCommunityWishLists);
        sortFilter.addEventListener("change", loadCommunityWishLists);

        let resizeTimer;
        window.addEventListener("resize", () => {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(updateCharts, 250);
        });

        showView("explore");
        updateProgress();

        document.addEventListener("click", function (e) {
          const btn = e.target.closest(".add-to-wishlist-btn");
          if (btn) {
            const id = parseInt(btn.dataset.id);
            const product = sampleProducts.find((p) => p.id === id);
            if (product) {
              const alreadyAdded = currentWishList.some(
                (item) => item.id === id
              );
              if (!alreadyAdded) {
                currentWishList.push({ ...product, claimed: false });
                loadWishList();
                sendToast(
                  `"${product.title}" added to your wishlist!`,
                  "success"
                );
              } else {
                sendToast(
                  `"${product.title}" is already in your wishlist.`,
                  "warning"
                );
              }
            }
          }
        });
      }

      document.addEventListener("DOMContentLoaded", initApp);

      document
        .getElementById("enableCollaboration")
        .addEventListener("change", function () {
          const collaborationOptions = document.getElementById(
            "collaborationOptions"
          );
          if (this.checked) {
            collaborationOptions.classList.remove("hidden");
          } else {
            collaborationOptions.classList.add("hidden");
          }
        });
    </script>
  </body>
</html>